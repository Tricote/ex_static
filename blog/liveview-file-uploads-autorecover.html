<!DOCTYPE html>
<html lang="en" class="[scrollbar-gutter:stable]">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="PhQsLy8zHHkWCREYC21VODA5LnozNAhsuLAfNjuIXCejS8dQClTNFUZ3">
    <title data-suffix=" · Phoenix Framework">
ExStatic
     · Phoenix Framework</title>
    <link phx-track-static rel="stylesheet" href="../assets/app-a06caf1378f3d4e3dd26f04c7d23196a.css">
    <script defer phx-track-static type="text/javascript" src="../assets/app-63c815f0894ce301efe8d07ba30e3cd6.js">
    </script>
  </head>
  <body class="bg-white antialiased">
<div class="container">
  <header class="blog-header py-3">
    <div class="row flex-nowrap justify-content-between align-items-center">
      <div class="col-4 pt-1"></div>
      <div class="col-4 text-center">
        <a class="blog-header-logo text-dark" href="../index.html">ExStatic</a>
      </div>
      <div class="col-4 d-flex justify-content-end align-items-center"></div>
    </div>
  </header>

  <div class="nav-scroller py-1 mb-2">
    <nav class="nav d-flex justify-content-center">
      <a class="nav-link text-muted" href="../index.html">Blog</a>
      <a class="nav-link text-muted" href="../about.html">About</a>
    </nav>
  </div>
</div>

<main class="container">
<main class="container">
  <div class="row mb-5">
    <div class="col-md-9">
      <div class="card shadow-sm shadow-hover position-relative mb-3">
        <div class="card-body">
          <p class="mb-1">
            <strong class="text-primary">
#Phoenix
            </strong>
          </p>
          <h3 class="card-title mb-2">Handling File Uploads in Phoenix LiveView resilient to server restarts</h3>

          <p class="card-text mb-1 text-muted">2025-07-07</p>
          <hr>
          <div class="article-body">
<p>
While Phoenix LiveView handles many aspects of file uploads elegantly, managing server restarts on forms with uploads isn’t completely handled by default. The auto-recovery mechanism works well for regular form fields so that if a server restart occurs while a user is filling out a form, all the standard fields are recovered automatically. However, file uploads are not.</p>
<p>
In this post, I’ll walk through a robust approach to managing file uploads in LiveView that survive server restarts and provide a seamless user experience.</p>
<p>
We’ll build a blog post system with document uploads using a step-by-step approach. Each <code class="inline">Post</code> can have multiple associated <code class="inline">Document</code> files that users can upload through both “new” and “edit” forms. Starting with basic upload functionality, we’ll progressively add auto-recovery and cleanup mechanisms.</p>
<p>
Note that we’ll use the <code class="inline">Waffle</code> and <code class="inline">Waffle.Ecto</code> libraries to handle file uploads.</p>
<h2 id="file-upload">
Step 1: Basic File Upload and Association</h2>
<p>
First, let’s set up our schemas and implement the basic file upload functionality. We’ll create a <code class="inline">Post</code> schema with associated <code class="inline">Document</code> records.</p>
<h3>
Schema Setup</h3>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Blog.Post</span><span class="w"> </span><span class="k" data-group-id="0958294644-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;blog_posts&quot;</span><span class="w"> </span><span class="k" data-group-id="0958294644-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:content</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">

    </span><span class="n">has_many</span><span class="w"> </span><span class="ss">:documents</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Blog.Document</span><span class="p">,</span><span class="w">
      </span><span class="ss">on_replace</span><span class="p">:</span><span class="w"> </span><span class="ss">:delete</span><span class="p">,</span><span class="w">
      </span><span class="ss">foreign_key</span><span class="p">:</span><span class="w"> </span><span class="ss">:post_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">preload_order</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0958294644-3">[</span><span class="ss">desc</span><span class="p">:</span><span class="w"> </span><span class="ss">:inserted_at</span><span class="p" data-group-id="0958294644-3">]</span><span class="w">

    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:author</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Accounts.User</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="0958294644-4">(</span><span class="p" data-group-id="0958294644-4">)</span><span class="w">
  </span><span class="k" data-group-id="0958294644-2">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">changeset</span><span class="p" data-group-id="0958294644-5">(</span><span class="n">post</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="0958294644-5">)</span><span class="w"> </span><span class="k" data-group-id="0958294644-6">do</span><span class="w">
    </span><span class="n">post</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="0958294644-7">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0958294644-8">[</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:content</span><span class="p" data-group-id="0958294644-8">]</span><span class="p" data-group-id="0958294644-7">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="0958294644-9">(</span><span class="p" data-group-id="0958294644-10">[</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:content</span><span class="p" data-group-id="0958294644-10">]</span><span class="p" data-group-id="0958294644-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">maybe_put_documents</span><span class="p" data-group-id="0958294644-11">(</span><span class="n">documents</span><span class="p" data-group-id="0958294644-11">)</span><span class="w">
  </span><span class="k" data-group-id="0958294644-6">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">maybe_put_documents</span><span class="p" data-group-id="0958294644-12">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="0958294644-12">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">maybe_put_documents</span><span class="p" data-group-id="0958294644-13">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="p" data-group-id="0958294644-13">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_list</span><span class="p" data-group-id="0958294644-14">(</span><span class="n">documents</span><span class="p" data-group-id="0958294644-14">)</span><span class="w"> </span><span class="k" data-group-id="0958294644-15">do</span><span class="w">
    </span><span class="n">put_assoc</span><span class="p" data-group-id="0958294644-16">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="ss">:documents</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="p" data-group-id="0958294644-16">)</span><span class="w">
  </span><span class="k" data-group-id="0958294644-15">end</span><span class="w">
</span><span class="k" data-group-id="0958294644-1">end</span></code></pre>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Blog.Document</span><span class="w"> </span><span class="k" data-group-id="4172376631-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Waffle.Ecto.Schema</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;blog_documents&quot;</span><span class="w"> </span><span class="k" data-group-id="4172376631-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:file</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Blog.DocumentFile.Type</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:post</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Blog.Post</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:creator</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Accounts.User</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="4172376631-3">(</span><span class="p" data-group-id="4172376631-3">)</span><span class="w">
  </span><span class="k" data-group-id="4172376631-2">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">changeset</span><span class="p" data-group-id="4172376631-4">(</span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="4172376631-4">)</span><span class="w"> </span><span class="k" data-group-id="4172376631-5">do</span><span class="w">
    </span><span class="n">document</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="4172376631-6">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4172376631-7">[</span><span class="p" data-group-id="4172376631-7">]</span><span class="p" data-group-id="4172376631-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="4172376631-8">(</span><span class="p" data-group-id="4172376631-9">[</span><span class="ss">:creator_id</span><span class="p" data-group-id="4172376631-9">]</span><span class="p" data-group-id="4172376631-8">)</span><span class="w">
  </span><span class="k" data-group-id="4172376631-5">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">file_changeset</span><span class="p" data-group-id="4172376631-10">(</span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="4172376631-10">)</span><span class="w"> </span><span class="k" data-group-id="4172376631-11">do</span><span class="w">
    </span><span class="n">document</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast_attachments</span><span class="p" data-group-id="4172376631-12">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4172376631-13">[</span><span class="ss">:file</span><span class="p" data-group-id="4172376631-13">]</span><span class="p" data-group-id="4172376631-12">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="4172376631-14">(</span><span class="p" data-group-id="4172376631-15">[</span><span class="ss">:file</span><span class="p" data-group-id="4172376631-15">]</span><span class="p" data-group-id="4172376631-14">)</span><span class="w">
  </span><span class="k" data-group-id="4172376631-11">end</span><span class="w">
</span><span class="k" data-group-id="4172376631-1">end</span></code></pre>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Blog.DocumentFile</span><span class="w"> </span><span class="k" data-group-id="4323286996-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Waffle.Definition</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Waffle.Ecto.Definition</span><span class="w">

  </span><span class="na">@versions</span><span class="w"> </span><span class="p" data-group-id="4323286996-2">[</span><span class="ss">:original</span><span class="p" data-group-id="4323286996-2">]</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">storage_dir</span><span class="p" data-group-id="4323286996-3">(</span><span class="c">_version</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4323286996-4">{</span><span class="c">_file</span><span class="p">,</span><span class="w"> </span><span class="n">document</span><span class="p" data-group-id="4323286996-4">}</span><span class="p" data-group-id="4323286996-3">)</span><span class="w"> </span><span class="k" data-group-id="4323286996-5">do</span><span class="w">
    </span><span class="s">&quot;uploads/blog_documents/</span><span class="si" data-group-id="4323286996-6">#{</span><span class="n">document</span><span class="o">.</span><span class="n">id</span><span class="si" data-group-id="4323286996-6">}</span><span class="s">&quot;</span><span class="w">
  </span><span class="k" data-group-id="4323286996-5">end</span><span class="w">
</span><span class="k" data-group-id="4323286996-1">end</span></code></pre>
<h3>
Context Functions</h3>
<p>
Let’s add the core functions in our context module to handle document creation and post management:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Blog</span><span class="w"> </span><span class="k" data-group-id="1489589936-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Query</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">MyApp.Repo</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">MyApp.Blog.Post</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">MyApp.Blog.Document</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">MyApp.Blog.DocumentFile</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Logger</span><span class="w">

  </span><span class="c1"># Basic Post CRUD operations</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_post!</span><span class="p" data-group-id="1489589936-2">(</span><span class="n">id</span><span class="p" data-group-id="1489589936-2">)</span><span class="w"> </span><span class="k" data-group-id="1489589936-3">do</span><span class="w">
    </span><span class="nc">Post</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="1489589936-4">(</span><span class="n">id</span><span class="p" data-group-id="1489589936-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">preload_associations</span><span class="p" data-group-id="1489589936-5">(</span><span class="p" data-group-id="1489589936-6">[</span><span class="ss">:documents</span><span class="p" data-group-id="1489589936-6">]</span><span class="p" data-group-id="1489589936-5">)</span><span class="w">
  </span><span class="k" data-group-id="1489589936-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">preload_associations</span><span class="p" data-group-id="1489589936-7">(</span><span class="n">post_or_posts</span><span class="p">,</span><span class="w"> </span><span class="n">preloads</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="1489589936-8">[</span><span class="ss">:documents</span><span class="p" data-group-id="1489589936-8">]</span><span class="p" data-group-id="1489589936-7">)</span><span class="w"> </span><span class="k" data-group-id="1489589936-9">do</span><span class="w">
    </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="1489589936-10">(</span><span class="n">post_or_posts</span><span class="p">,</span><span class="w"> </span><span class="n">preloads</span><span class="p" data-group-id="1489589936-10">)</span><span class="w">
  </span><span class="k" data-group-id="1489589936-9">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p" data-group-id="1489589936-11">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1489589936-12">%{</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">author_id</span><span class="p" data-group-id="1489589936-12">}</span><span class="p" data-group-id="1489589936-11">)</span><span class="w"> </span><span class="k" data-group-id="1489589936-13">do</span><span class="w">
    </span><span class="p" data-group-id="1489589936-14">%</span><span class="nc" data-group-id="1489589936-14">Post</span><span class="p" data-group-id="1489589936-14">{</span><span class="ss">author_id</span><span class="p">:</span><span class="w"> </span><span class="n">author_id</span><span class="p" data-group-id="1489589936-14">}</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Post</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="1489589936-15">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="p" data-group-id="1489589936-15">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="1489589936-16">(</span><span class="p" data-group-id="1489589936-16">)</span><span class="w">
  </span><span class="k" data-group-id="1489589936-13">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">update_post</span><span class="p" data-group-id="1489589936-17">(</span><span class="p" data-group-id="1489589936-18">%</span><span class="nc" data-group-id="1489589936-18">Post</span><span class="p" data-group-id="1489589936-18">{</span><span class="p" data-group-id="1489589936-18">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">post</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="1489589936-17">)</span><span class="w"> </span><span class="k" data-group-id="1489589936-19">do</span><span class="w">
    </span><span class="n">post</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Post</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="1489589936-20">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="p" data-group-id="1489589936-20">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="1489589936-21">(</span><span class="p" data-group-id="1489589936-21">)</span><span class="w">
  </span><span class="k" data-group-id="1489589936-19">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change_post</span><span class="p" data-group-id="1489589936-22">(</span><span class="p" data-group-id="1489589936-23">%</span><span class="nc" data-group-id="1489589936-23">Post</span><span class="p" data-group-id="1489589936-23">{</span><span class="p" data-group-id="1489589936-23">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">post</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="1489589936-24">%{</span><span class="p" data-group-id="1489589936-24">}</span><span class="p" data-group-id="1489589936-22">)</span><span class="w"> </span><span class="k" data-group-id="1489589936-25">do</span><span class="w">
    </span><span class="nc">Post</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="1489589936-26">(</span><span class="n">post</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="1489589936-26">)</span><span class="w">
  </span><span class="k" data-group-id="1489589936-25">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_document!</span><span class="p" data-group-id="1489589936-27">(</span><span class="n">id</span><span class="p" data-group-id="1489589936-27">)</span><span class="w"> </span><span class="k" data-group-id="1489589936-28">do</span><span class="w">
    </span><span class="nc">Document</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">where</span><span class="p" data-group-id="1489589936-29">(</span><span class="p" data-group-id="1489589936-30">[</span><span class="n">d</span><span class="p" data-group-id="1489589936-30">]</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">id</span><span class="p" data-group-id="1489589936-29">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">one!</span><span class="p" data-group-id="1489589936-31">(</span><span class="p" data-group-id="1489589936-31">)</span><span class="w">
  </span><span class="k" data-group-id="1489589936-28">end</span><span class="w">

  </span><span class="c1"># Document creation function</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_unattached_document</span><span class="p" data-group-id="1489589936-32">(</span><span class="n">attrs</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="1489589936-33">%{</span><span class="p" data-group-id="1489589936-33">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1489589936-34">%{</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">creator_id</span><span class="p" data-group-id="1489589936-34">}</span><span class="p" data-group-id="1489589936-32">)</span><span class="w"> </span><span class="k" data-group-id="1489589936-35">do</span><span class="w">
    </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="p" data-group-id="1489589936-36">%</span><span class="nc" data-group-id="1489589936-36">Document</span><span class="p" data-group-id="1489589936-36">{</span><span class="ss">creator_id</span><span class="p">:</span><span class="w"> </span><span class="n">creator_id</span><span class="p" data-group-id="1489589936-36">}</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Document</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="1489589936-37">(</span><span class="n">attrs</span><span class="p" data-group-id="1489589936-37">)</span><span class="w">

    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="1489589936-38">(</span><span class="p" data-group-id="1489589936-38">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="1489589936-39">(</span><span class="ss">:document</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="1489589936-39">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="1489589936-40">(</span><span class="w">
        </span><span class="ss">:document_with_file</span><span class="p">,</span><span class="w">
        </span><span class="o">&amp;</span><span class="nc">Document</span><span class="o">.</span><span class="n">file_changeset</span><span class="p" data-group-id="1489589936-41">(</span><span class="ni">&amp;1</span><span class="o">.</span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="1489589936-41">)</span><span class="w">
      </span><span class="p" data-group-id="1489589936-40">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">transaction</span><span class="p" data-group-id="1489589936-42">(</span><span class="p" data-group-id="1489589936-42">)</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k" data-group-id="1489589936-43">do</span><span class="w">
      </span><span class="p" data-group-id="1489589936-44">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1489589936-45">%{</span><span class="ss">document_with_file</span><span class="p">:</span><span class="w"> </span><span class="n">document</span><span class="p" data-group-id="1489589936-45">}</span><span class="p" data-group-id="1489589936-44">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1489589936-46">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">document</span><span class="p" data-group-id="1489589936-46">}</span><span class="w">
      </span><span class="p" data-group-id="1489589936-47">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="1489589936-47">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1489589936-48">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="1489589936-48">}</span><span class="w">
    </span><span class="k" data-group-id="1489589936-43">end</span><span class="w">
  </span><span class="k" data-group-id="1489589936-35">end</span><span class="w">
</span><span class="k" data-group-id="1489589936-1">end</span></code></pre>
<p>
Note that the <code class="inline">create_unattached_document/2</code> function has two steps:</p>
<ul>
  <li>
first it creates the document entry in the DB,  </li>
  <li>
then it uploads the file to the storage backend.   </li>
</ul>
<p>
This allows to use the document ID in the storage directory with Waffle. This process is explained in the Waffle documentation here: <a href="https://hexdocs.pm/waffle_ecto/filepath-with-id.html">How to use :id in filepath</a></p>
<h3>
LiveView Implementation</h3>
<p>
Now, let’s create the LiveView module to handle blog post creation with file uploads:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyAppWeb.BlogLive.Form</span><span class="w"> </span><span class="k" data-group-id="1233038171-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">MyAppWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Logger</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">MyApp.Blog</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">MyApp.Blog.Post</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">mount</span><span class="p" data-group-id="1233038171-2">(</span><span class="c">_params</span><span class="p">,</span><span class="w"> </span><span class="c">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1233038171-2">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-3">do</span><span class="w">
    </span><span class="p" data-group-id="1233038171-4">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w">
     </span><span class="n">socket</span><span class="w">
     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">allow_upload</span><span class="p" data-group-id="1233038171-5">(</span><span class="ss">:document</span><span class="p">,</span><span class="w">
       </span><span class="ss">accept</span><span class="p">:</span><span class="w"> </span><span class="sx">~w(.pdf .jpg .png)</span><span class="p">,</span><span class="w">
       </span><span class="ss">max_entries</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
       </span><span class="ss">max_file_size</span><span class="p">:</span><span class="w"> </span><span class="mi">10_000_000</span><span class="p">,</span><span class="w">
       </span><span class="ss">auto_upload</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
       </span><span class="ss">progress</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">handle_progress</span><span class="o">/</span><span class="mi">3</span><span class="w">
     </span><span class="p" data-group-id="1233038171-5">)</span><span class="p" data-group-id="1233038171-4">}</span><span class="w">
  </span><span class="k" data-group-id="1233038171-3">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_params</span><span class="p" data-group-id="1233038171-6">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="c">_url</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1233038171-6">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-7">do</span><span class="w">
    </span><span class="p" data-group-id="1233038171-8">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">apply_action</span><span class="p" data-group-id="1233038171-9">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">live_action</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="1233038171-9">)</span><span class="p" data-group-id="1233038171-8">}</span><span class="w">
  </span><span class="k" data-group-id="1233038171-7">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">apply_action</span><span class="p" data-group-id="1233038171-10">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:new</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="1233038171-10">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-11">do</span><span class="w">
    </span><span class="n">current_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_user</span><span class="w">
    </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1233038171-12">%</span><span class="nc" data-group-id="1233038171-12">Post</span><span class="p" data-group-id="1233038171-12">{</span><span class="w">
      </span><span class="ss">author_id</span><span class="p">:</span><span class="w"> </span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w">
      </span><span class="ss">documents</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1233038171-13">[</span><span class="p" data-group-id="1233038171-13">]</span><span class="w">
    </span><span class="p" data-group-id="1233038171-12">}</span><span class="w">

    </span><span class="n">socket</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-14">(</span><span class="ss">:page_title</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;New Blog Post&quot;</span><span class="p" data-group-id="1233038171-14">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-15">(</span><span class="ss">:post</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="p" data-group-id="1233038171-15">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-16">(</span><span class="ss">:documents</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1233038171-17">[</span><span class="p" data-group-id="1233038171-17">]</span><span class="p" data-group-id="1233038171-16">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-18">(</span><span class="ss">:form</span><span class="p">,</span><span class="w"> </span><span class="n">to_form</span><span class="p" data-group-id="1233038171-19">(</span><span class="nc">Blog</span><span class="o">.</span><span class="n">change_post</span><span class="p" data-group-id="1233038171-20">(</span><span class="n">post</span><span class="p" data-group-id="1233038171-20">)</span><span class="p" data-group-id="1233038171-19">)</span><span class="p" data-group-id="1233038171-18">)</span><span class="w">
  </span><span class="k" data-group-id="1233038171-11">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">apply_action</span><span class="p" data-group-id="1233038171-21">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:edit</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1233038171-22">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="1233038171-22">}</span><span class="p" data-group-id="1233038171-21">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-23">do</span><span class="w">
    </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Blog</span><span class="o">.</span><span class="n">get_post!</span><span class="p" data-group-id="1233038171-24">(</span><span class="n">id</span><span class="p" data-group-id="1233038171-24">)</span><span class="w">

    </span><span class="n">socket</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-25">(</span><span class="ss">:page_title</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Edit Blog Post&quot;</span><span class="p" data-group-id="1233038171-25">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-26">(</span><span class="ss">:post</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="p" data-group-id="1233038171-26">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-27">(</span><span class="ss">:documents</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="o">.</span><span class="n">documents</span><span class="p" data-group-id="1233038171-27">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-28">(</span><span class="ss">:form</span><span class="p">,</span><span class="w"> </span><span class="n">to_form</span><span class="p" data-group-id="1233038171-29">(</span><span class="nc">Blog</span><span class="o">.</span><span class="n">change_post</span><span class="p" data-group-id="1233038171-30">(</span><span class="n">post</span><span class="p" data-group-id="1233038171-30">)</span><span class="p" data-group-id="1233038171-29">)</span><span class="p" data-group-id="1233038171-28">)</span><span class="w">
  </span><span class="k" data-group-id="1233038171-23">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="1233038171-31">(</span><span class="s">&quot;validate&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1233038171-32">%{</span><span class="s">&quot;post&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">post_params</span><span class="p" data-group-id="1233038171-32">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1233038171-31">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-33">do</span><span class="w">
    </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Blog</span><span class="o">.</span><span class="n">change_post</span><span class="p" data-group-id="1233038171-34">(</span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">post</span><span class="p">,</span><span class="w"> </span><span class="n">post_params</span><span class="p" data-group-id="1233038171-34">)</span><span class="w">

    </span><span class="p" data-group-id="1233038171-35">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w">
     </span><span class="n">socket</span><span class="w">
     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-36">(</span><span class="ss">form</span><span class="p">:</span><span class="w"> </span><span class="n">to_form</span><span class="p" data-group-id="1233038171-37">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:validate</span><span class="p" data-group-id="1233038171-37">)</span><span class="p" data-group-id="1233038171-36">)</span><span class="p" data-group-id="1233038171-35">}</span><span class="w">
  </span><span class="k" data-group-id="1233038171-33">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="1233038171-38">(</span><span class="s">&quot;save&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1233038171-39">%{</span><span class="s">&quot;post&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">post_params</span><span class="p" data-group-id="1233038171-39">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1233038171-38">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-40">do</span><span class="w">
    </span><span class="n">save_post</span><span class="p" data-group-id="1233038171-41">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">live_action</span><span class="p">,</span><span class="w"> </span><span class="n">post_params</span><span class="p" data-group-id="1233038171-41">)</span><span class="w">
  </span><span class="k" data-group-id="1233038171-40">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="1233038171-42">(</span><span class="s">&quot;delete-document&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1233038171-43">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">document_id</span><span class="p" data-group-id="1233038171-43">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1233038171-42">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-44">do</span><span class="w">
    </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">post</span><span class="w">
    </span><span class="n">documents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">documents</span><span class="w">

    </span><span class="n">document_to_delete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Blog</span><span class="o">.</span><span class="n">get_document!</span><span class="p" data-group-id="1233038171-45">(</span><span class="n">document_id</span><span class="p" data-group-id="1233038171-45">)</span><span class="w">

    </span><span class="c1"># Remove from documents list</span><span class="w">
    </span><span class="n">documents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reject</span><span class="p" data-group-id="1233038171-46">(</span><span class="n">documents</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p" data-group-id="1233038171-47">(</span><span class="ni">&amp;1</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">document_to_delete</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="1233038171-47">)</span><span class="p" data-group-id="1233038171-46">)</span><span class="w">

    </span><span class="p" data-group-id="1233038171-48">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-49">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:documents</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="p" data-group-id="1233038171-49">)</span><span class="p" data-group-id="1233038171-48">}</span><span class="w">
  </span><span class="k" data-group-id="1233038171-44">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="1233038171-50">(</span><span class="s">&quot;cancel-upload&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1233038171-51">%{</span><span class="s">&quot;ref&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">ref</span><span class="p" data-group-id="1233038171-51">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1233038171-50">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-52">do</span><span class="w">
    </span><span class="p" data-group-id="1233038171-53">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">cancel_upload</span><span class="p" data-group-id="1233038171-54">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:document</span><span class="p">,</span><span class="w"> </span><span class="n">ref</span><span class="p" data-group-id="1233038171-54">)</span><span class="p" data-group-id="1233038171-53">}</span><span class="w">
  </span><span class="k" data-group-id="1233038171-52">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_progress</span><span class="p" data-group-id="1233038171-55">(</span><span class="ss">:document</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1233038171-55">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-56">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="n">entry</span><span class="o">.</span><span class="n">done?</span><span class="w"> </span><span class="k" data-group-id="1233038171-57">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="1233038171-58">(</span><span class="s">&quot;Upload finished&quot;</span><span class="p" data-group-id="1233038171-58">)</span><span class="w">

      </span><span class="n">document</span><span class="w"> </span><span class="o">=</span><span class="w">
        </span><span class="n">consume_uploaded_entry</span><span class="p" data-group-id="1233038171-59">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="1233038171-60">fn</span><span class="w"> </span><span class="p" data-group-id="1233038171-61">%{</span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="n">path</span><span class="p" data-group-id="1233038171-61">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="n">upload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1233038171-62">%</span><span class="nc" data-group-id="1233038171-62">Plug.Upload</span><span class="p" data-group-id="1233038171-62">{</span><span class="w">
            </span><span class="ss">content_type</span><span class="p">:</span><span class="w"> </span><span class="n">entry</span><span class="o">.</span><span class="n">client_type</span><span class="p">,</span><span class="w">
            </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="n">entry</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span><span class="w">
            </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="n">path</span><span class="w">
          </span><span class="p" data-group-id="1233038171-62">}</span><span class="w">

          </span><span class="p" data-group-id="1233038171-63">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">document</span><span class="p" data-group-id="1233038171-63">}</span><span class="w"> </span><span class="o">=</span><span class="w">
            </span><span class="nc">Blog</span><span class="o">.</span><span class="n">create_unattached_document</span><span class="p" data-group-id="1233038171-64">(</span><span class="p" data-group-id="1233038171-65">%{</span><span class="s">&quot;file&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">upload</span><span class="p" data-group-id="1233038171-65">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_user</span><span class="p" data-group-id="1233038171-64">)</span><span class="w">

          </span><span class="n">document</span><span class="w">
        </span><span class="k" data-group-id="1233038171-60">end</span><span class="p" data-group-id="1233038171-59">)</span><span class="w">

      </span><span class="p" data-group-id="1233038171-66">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w">
       </span><span class="n">socket</span><span class="w">
       </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">update</span><span class="p" data-group-id="1233038171-67">(</span><span class="ss">:documents</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p" data-group-id="1233038171-68">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="1233038171-69">[</span><span class="n">document</span><span class="p" data-group-id="1233038171-69">]</span><span class="p" data-group-id="1233038171-68">)</span><span class="p" data-group-id="1233038171-67">)</span><span class="p" data-group-id="1233038171-66">}</span><span class="w">
    </span><span class="k" data-group-id="1233038171-57">else</span><span class="w">
      </span><span class="p" data-group-id="1233038171-70">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="1233038171-70">}</span><span class="w">
    </span><span class="k" data-group-id="1233038171-57">end</span><span class="w">
  </span><span class="k" data-group-id="1233038171-56">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">save_post</span><span class="p" data-group-id="1233038171-71">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:edit</span><span class="p">,</span><span class="w"> </span><span class="n">post_params</span><span class="p" data-group-id="1233038171-71">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-72">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Blog</span><span class="o">.</span><span class="n">update_post</span><span class="p" data-group-id="1233038171-73">(</span><span class="w">
           </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">post</span><span class="p">,</span><span class="w">
           </span><span class="n">post_params</span><span class="p">,</span><span class="w">
           </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">documents</span><span class="w">
         </span><span class="p" data-group-id="1233038171-73">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-74">do</span><span class="w">
      </span><span class="p" data-group-id="1233038171-75">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="p" data-group-id="1233038171-75">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1233038171-76">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w">
         </span><span class="n">socket</span><span class="w">
         </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="1233038171-77">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Post updated successfully&quot;</span><span class="p" data-group-id="1233038171-77">)</span><span class="w">
         </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">push_navigate</span><span class="p" data-group-id="1233038171-78">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/blog/posts/</span><span class="si" data-group-id="1233038171-79">#{</span><span class="n">post</span><span class="si" data-group-id="1233038171-79">}</span><span class="sx">&quot;</span><span class="p" data-group-id="1233038171-78">)</span><span class="p" data-group-id="1233038171-76">}</span><span class="w">

      </span><span class="p" data-group-id="1233038171-80">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1233038171-81">%</span><span class="nc" data-group-id="1233038171-81">Ecto.Changeset</span><span class="p" data-group-id="1233038171-81">{</span><span class="p" data-group-id="1233038171-81">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="1233038171-80">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1233038171-82">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-83">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">form</span><span class="p">:</span><span class="w"> </span><span class="n">to_form</span><span class="p" data-group-id="1233038171-84">(</span><span class="n">changeset</span><span class="p" data-group-id="1233038171-84">)</span><span class="p" data-group-id="1233038171-83">)</span><span class="p" data-group-id="1233038171-82">}</span><span class="w">
    </span><span class="k" data-group-id="1233038171-74">end</span><span class="w">
  </span><span class="k" data-group-id="1233038171-72">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">save_post</span><span class="p" data-group-id="1233038171-85">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:new</span><span class="p">,</span><span class="w"> </span><span class="n">post_params</span><span class="p" data-group-id="1233038171-85">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-86">do</span><span class="w">
    </span><span class="n">current_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_user</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="nc">Blog</span><span class="o">.</span><span class="n">create_post</span><span class="p" data-group-id="1233038171-87">(</span><span class="w">
           </span><span class="n">post_params</span><span class="p">,</span><span class="w">
           </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">documents</span><span class="p">,</span><span class="w">
           </span><span class="n">current_user</span><span class="w">
         </span><span class="p" data-group-id="1233038171-87">)</span><span class="w"> </span><span class="k" data-group-id="1233038171-88">do</span><span class="w">
      </span><span class="p" data-group-id="1233038171-89">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="p" data-group-id="1233038171-89">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1233038171-90">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w">
         </span><span class="n">socket</span><span class="w">
         </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="1233038171-91">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Post created successfully&quot;</span><span class="p" data-group-id="1233038171-91">)</span><span class="w">
         </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">push_navigate</span><span class="p" data-group-id="1233038171-92">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/blog/posts/</span><span class="si" data-group-id="1233038171-93">#{</span><span class="n">post</span><span class="si" data-group-id="1233038171-93">}</span><span class="sx">&quot;</span><span class="p" data-group-id="1233038171-92">)</span><span class="p" data-group-id="1233038171-90">}</span><span class="w">

      </span><span class="p" data-group-id="1233038171-94">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1233038171-95">%</span><span class="nc" data-group-id="1233038171-95">Ecto.Changeset</span><span class="p" data-group-id="1233038171-95">{</span><span class="p" data-group-id="1233038171-95">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="1233038171-94">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1233038171-96">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="1233038171-97">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">form</span><span class="p">:</span><span class="w"> </span><span class="n">to_form</span><span class="p" data-group-id="1233038171-98">(</span><span class="n">changeset</span><span class="p" data-group-id="1233038171-98">)</span><span class="p" data-group-id="1233038171-97">)</span><span class="p" data-group-id="1233038171-96">}</span><span class="w">
    </span><span class="k" data-group-id="1233038171-88">end</span><span class="w">
  </span><span class="k" data-group-id="1233038171-86">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">error_to_string</span><span class="p" data-group-id="1233038171-99">(</span><span class="ss">:too_large</span><span class="p" data-group-id="1233038171-99">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;File is too large (max 10MB)&quot;</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">error_to_string</span><span class="p" data-group-id="1233038171-100">(</span><span class="ss">:not_accepted</span><span class="p" data-group-id="1233038171-100">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Unacceptable file type (PDF, JPG, PNG only)&quot;</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">error_to_string</span><span class="p" data-group-id="1233038171-101">(</span><span class="ss">:too_many_files</span><span class="p" data-group-id="1233038171-101">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Too many files selected&quot;</span><span class="w">
</span><span class="k" data-group-id="1233038171-1">end</span></code></pre>
<p>
The <code class="inline">consume_uploaded_entry/3</code> function creates documents immediately upon upload, but these remain unattached to any blog post (which may not even exist yet during the <code class="inline">new</code> action). The actual association happens later when the user saves the form.</p>
<p>
When the save button is clicked, the <code class="inline">create_post/3</code> or <code class="inline">update_post/3</code> functions link the uploaded documents to the Post using <code class="inline">put_assoc(changeset, :documents, socket.assigns.documents)</code>. The <code class="inline">on_replace: :delete</code> option in the Post schema ensures that documents removed from the <code class="inline">socket.assigns.documents</code> list are properly deleted from the database and from the storage.</p>
<p>
However, documents that are uploaded but then removed <em>before saving the Post</em> will remain in the database and storage as “orphan documents” until a cleanup process removes them.</p>
<h3>
Basic Template with Upload UI</h3>
<p>
Here’s our the raw LiveView template</p>
<pre><code class="makeup html"><span class="p" data-group-id="0756305527-1">&lt;</span><span class="s">.form</span><span class="w"> </span><span class="na">for</span><span class="o">=</span><span class="s">{@form}</span><span class="w"> </span><span class="s">phx-change</span><span class="o">=</span><span class="s">&quot;validate&quot;</span><span class="w"> </span><span class="s">phx-submit</span><span class="o">=</span><span class="s">&quot;save&quot;</span><span class="p" data-group-id="0756305527-1">&gt;</span><span class="s">
  </span><span class="p" data-group-id="0756305527-2">&lt;</span><span class="s">.input</span><span class="w"> </span><span class="s">field</span><span class="o">=</span><span class="s">{@form[:title]}</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="na">label</span><span class="o">=</span><span class="s">&quot;Title&quot;</span><span class="w"> </span><span class="na">required</span><span class="w"> </span><span class="p" data-group-id="0756305527-2">/&gt;</span><span class="w">
  </span><span class="p" data-group-id="0756305527-3">&lt;</span><span class="s">.input</span><span class="w"> </span><span class="s">field</span><span class="o">=</span><span class="s">{@form[:content]}</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;textarea&quot;</span><span class="w"> </span><span class="na">label</span><span class="o">=</span><span class="s">&quot;Content&quot;</span><span class="w"> </span><span class="na">required</span><span class="w"> </span><span class="p" data-group-id="0756305527-3">/&gt;</span><span class="w">

  </span><span class="p" data-group-id="0756305527-4">&lt;</span><span class="k">h3</span><span class="p" data-group-id="0756305527-4">&gt;</span><span class="s">Documents</span><span class="p" data-group-id="0756305527-5">&lt;/</span><span class="k">h3</span><span class="p" data-group-id="0756305527-5">&gt;</span><span class="s">
  </span><span class="p" data-group-id="0756305527-6">&lt;</span><span class="k">div</span><span class="w"> </span><span class="s">phx-drop-target</span><span class="o">=</span><span class="s">{@uploads.document.ref}</span><span class="p" data-group-id="0756305527-6">&gt;</span><span class="s">
    </span><span class="p" data-group-id="0756305527-7">&lt;</span><span class="s">.live_file_input</span><span class="w"> </span><span class="s">upload</span><span class="o">=</span><span class="s">{@uploads.document}</span><span class="w"> </span><span class="p" data-group-id="0756305527-7">/&gt;</span><span class="w">

    </span><span class="p" data-group-id="0756305527-8">&lt;</span><span class="k">div</span><span class="p" data-group-id="0756305527-8">&gt;</span><span class="s">
      </span><span class="p" data-group-id="0756305527-9">&lt;</span><span class="s">%</span><span class="o">=</span><span class="w"> </span><span class="na">for</span><span class="w"> </span><span class="s">err</span><span class="w"> </span><span class="p" data-group-id="0756305527-10">&lt;</span><span class="s">-</span><span class="w"> </span><span class="s">upload_errors(@uploads.document)</span><span class="w"> </span><span class="s">do</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="0756305527-10">&gt;</span><span class="s">
        </span><span class="p" data-group-id="0756305527-11">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;alert</span><span class="w"> </span><span class="s">alert-danger&quot;</span><span class="p" data-group-id="0756305527-11">&gt;</span><span class="s">
          {error_to_string(err)}
        </span><span class="p" data-group-id="0756305527-12">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-12">&gt;</span><span class="s">
      </span><span class="p" data-group-id="0756305527-13">&lt;</span><span class="s">%</span><span class="w"> </span><span class="s">end</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="0756305527-13">&gt;</span><span class="s">
    </span><span class="p" data-group-id="0756305527-14">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-14">&gt;</span><span class="s">

    </span><span class="p" data-group-id="0756305527-15">&lt;</span><span class="k">div</span><span class="p" data-group-id="0756305527-15">&gt;</span><span class="s">
      </span><span class="p" data-group-id="0756305527-16">&lt;</span><span class="s">%</span><span class="o">=</span><span class="w"> </span><span class="na">for</span><span class="w"> </span><span class="s">entry</span><span class="w"> </span><span class="p" data-group-id="0756305527-17">&lt;</span><span class="s">-</span><span class="w"> </span><span class="s">@uploads.document.entries</span><span class="w"> </span><span class="s">do</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="0756305527-17">&gt;</span><span class="s">
        </span><span class="p" data-group-id="0756305527-18">&lt;</span><span class="k">div</span><span class="p" data-group-id="0756305527-18">&gt;</span><span class="s">
          </span><span class="p" data-group-id="0756305527-19">&lt;</span><span class="k">div</span><span class="p" data-group-id="0756305527-19">&gt;</span><span class="s">
            {entry.client_name}
          </span><span class="p" data-group-id="0756305527-20">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-20">&gt;</span><span class="s">
          </span><span class="p" data-group-id="0756305527-21">&lt;</span><span class="k">div</span><span class="p" data-group-id="0756305527-21">&gt;</span><span class="s">
            </span><span class="p" data-group-id="0756305527-22">&lt;</span><span class="k">div</span><span class="w">
              </span><span class="s">role</span><span class="o">=</span><span class="s">&quot;progressbar&quot;</span><span class="w">
              </span><span class="na">style</span><span class="o">=</span><span class="s">{&quot;width:</span><span class="w"> </span><span class="s">#{entry.progress}%&quot;}</span><span class="w">
              </span><span class="s">aria-valuenow</span><span class="o">=</span><span class="s">{entry.progress}</span><span class="w">
              </span><span class="s">aria-valuemin</span><span class="o">=</span><span class="s">&quot;0&quot;</span><span class="w">
              </span><span class="s">aria-valuemax</span><span class="o">=</span><span class="s">&quot;100&quot;</span><span class="w">
            </span><span class="p" data-group-id="0756305527-22">&gt;</span><span class="s">
              {entry.progress}%
            </span><span class="p" data-group-id="0756305527-23">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-23">&gt;</span><span class="s">
          </span><span class="p" data-group-id="0756305527-24">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-24">&gt;</span><span class="s">
        </span><span class="p" data-group-id="0756305527-25">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-25">&gt;</span><span class="s">
      </span><span class="p" data-group-id="0756305527-26">&lt;</span><span class="s">%</span><span class="w"> </span><span class="s">end</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="0756305527-26">&gt;</span><span class="s">
    </span><span class="p" data-group-id="0756305527-27">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-27">&gt;</span><span class="s">

    </span><span class="p" data-group-id="0756305527-28">&lt;</span><span class="k">h3</span><span class="p" data-group-id="0756305527-28">&gt;</span><span class="s">Uploaded Files</span><span class="p" data-group-id="0756305527-29">&lt;/</span><span class="k">h3</span><span class="p" data-group-id="0756305527-29">&gt;</span><span class="s">
    </span><span class="p" data-group-id="0756305527-30">&lt;</span><span class="s">%</span><span class="o">=</span><span class="w"> </span><span class="na">for</span><span class="w"> </span><span class="s">document</span><span class="w"> </span><span class="p" data-group-id="0756305527-31">&lt;</span><span class="s">-</span><span class="w"> </span><span class="s">@documents</span><span class="w"> </span><span class="s">do</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="0756305527-31">&gt;</span><span class="s">
      </span><span class="p" data-group-id="0756305527-32">&lt;</span><span class="k">div</span><span class="p" data-group-id="0756305527-32">&gt;</span><span class="s">{document.file.file_name}</span><span class="p" data-group-id="0756305527-33">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-33">&gt;</span><span class="s">
      </span><span class="p" data-group-id="0756305527-34">&lt;</span><span class="k">button</span><span class="w">
          </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span><span class="w">
          </span><span class="s">phx-click</span><span class="o">=</span><span class="s">&quot;delete-document&quot;</span><span class="w">
          </span><span class="s">phx-value-id</span><span class="o">=</span><span class="s">{document.id}</span><span class="w">
        </span><span class="p" data-group-id="0756305527-34">&gt;</span><span class="s">
        Delete document
      </span><span class="p" data-group-id="0756305527-35">&lt;/</span><span class="k">button</span><span class="p" data-group-id="0756305527-35">&gt;</span><span class="s">
    </span><span class="p" data-group-id="0756305527-36">&lt;</span><span class="s">%</span><span class="w"> </span><span class="s">end</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="0756305527-36">&gt;</span><span class="s">
  </span><span class="p" data-group-id="0756305527-37">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-37">&gt;</span><span class="s">

  </span><span class="p" data-group-id="0756305527-38">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="0756305527-38">&gt;</span><span class="s">
    </span><span class="p" data-group-id="0756305527-39">&lt;</span><span class="k">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p" data-group-id="0756305527-39">&gt;</span><span class="s">Save</span><span class="p" data-group-id="0756305527-40">&lt;/</span><span class="k">button</span><span class="p" data-group-id="0756305527-40">&gt;</span><span class="s">
  </span><span class="p" data-group-id="0756305527-41">&lt;/</span><span class="k">div</span><span class="p" data-group-id="0756305527-41">&gt;</span><span class="s">
</span><span class="p" data-group-id="0756305527-42">&lt;/</span><span class="s">.form</span><span class="p" data-group-id="0756305527-42">&gt;</span></code></pre>
<h2 id="auto-recover">
Step 2: Adding Auto-Recovery Mechanism</h2>
<p>
Our current implementation has a problem: if a server restart occurs while a user has uploaded documents but hasn’t saved the post yet, the <code class="inline">socket.assigns.documents</code> list is lost, causing the user to lose their uploaded (or “to be deleted”) files.</p>
<p>
While other <code class="inline">Post</code> fields are automatically recovered through LiveView’s standard form recovery mechanism (the client resends all form data and triggers the <code class="inline">validate</code> event on reconnect), this doesn’t work for documents since they aren’t represented by form input fields.</p>
<p>
The solution is to add hidden input fields containing the document IDs currently in <code class="inline">socket.assigns.documents</code>, allowing us to recover the uploaded documents during the form validation process.</p>
<pre><code class="makeup html"><span class="p" data-group-id="9402084306-1">&lt;</span><span class="s">.form</span><span class="w"> </span><span class="na">for</span><span class="o">=</span><span class="s">{@form}</span><span class="w"> </span><span class="s">phx-change</span><span class="o">=</span><span class="s">&quot;validate&quot;</span><span class="w"> </span><span class="s">phx-submit</span><span class="o">=</span><span class="s">&quot;save&quot;</span><span class="p" data-group-id="9402084306-1">&gt;</span><span class="s">
  </span><span class="p" data-group-id="9402084306-2">&lt;</span><span class="s">%</span><span class="o">=</span><span class="w"> </span><span class="na">for</span><span class="w"> </span><span class="s">document</span><span class="w"> </span><span class="p" data-group-id="9402084306-3">&lt;</span><span class="s">-</span><span class="w"> </span><span class="s">@documents</span><span class="w"> </span><span class="s">do</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="9402084306-3">&gt;</span><span class="s">
    </span><span class="p" data-group-id="9402084306-4">&lt;</span><span class="k">input</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;autorecover_document_ids[]&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="s">{document.id}</span><span class="w"> </span><span class="p" data-group-id="9402084306-4">/&gt;</span><span class="w">
  </span><span class="p" data-group-id="9402084306-5">&lt;</span><span class="s">%</span><span class="w"> </span><span class="s">end</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="9402084306-5">&gt;</span><span class="s">
</span><span class="c">&lt;!-- rest of the form --&gt;</span><span class="s">
 </span><span class="p" data-group-id="9402084306-6">&lt;/</span><span class="s">.form</span><span class="p" data-group-id="9402084306-6">&gt;</span></code></pre>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyAppWeb.BlogLive.Form</span><span class="w"> </span><span class="k" data-group-id="3081532453-1">do</span><span class="w">
  </span><span class="c1"># ... existing code</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="3081532453-2">(</span><span class="s">&quot;validate&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3081532453-3">%{</span><span class="s">&quot;post&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">post_params</span><span class="p" data-group-id="3081532453-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="3081532453-2">)</span><span class="w"> </span><span class="k" data-group-id="3081532453-4">do</span><span class="w">
    </span><span class="c1"># Handle autorecovery of documents</span><span class="w">
    </span><span class="n">documents</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">recover_documents</span><span class="p" data-group-id="3081532453-5">(</span><span class="w">
        </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">documents</span><span class="p">,</span><span class="w">
        </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="3081532453-6">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;autorecover_document_ids&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3081532453-7">[</span><span class="p" data-group-id="3081532453-7">]</span><span class="p" data-group-id="3081532453-6">)</span><span class="p">,</span><span class="w">
        </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_user</span><span class="w">
      </span><span class="p" data-group-id="3081532453-5">)</span><span class="w">

    </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Blog</span><span class="o">.</span><span class="n">change_post</span><span class="p" data-group-id="3081532453-8">(</span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">post</span><span class="p">,</span><span class="w"> </span><span class="n">post_params</span><span class="p" data-group-id="3081532453-8">)</span><span class="w">

    </span><span class="p" data-group-id="3081532453-9">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w">
     </span><span class="n">socket</span><span class="w">
     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="3081532453-10">(</span><span class="ss">form</span><span class="p">:</span><span class="w"> </span><span class="n">to_form</span><span class="p" data-group-id="3081532453-11">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:validate</span><span class="p" data-group-id="3081532453-11">)</span><span class="p" data-group-id="3081532453-10">)</span><span class="w">
     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="3081532453-12">(</span><span class="ss">:documents</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="p" data-group-id="3081532453-12">)</span><span class="p" data-group-id="3081532453-9">}</span><span class="w">
  </span><span class="k" data-group-id="3081532453-4">end</span><span class="w">

  </span><span class="c1"># Auto-recovery mechanism</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">recover_documents</span><span class="p" data-group-id="3081532453-13">(</span><span class="n">documents</span><span class="p">,</span><span class="w"> </span><span class="n">autorecover_document_ids</span><span class="p">,</span><span class="w"> </span><span class="n">current_user</span><span class="p" data-group-id="3081532453-13">)</span><span class="w"> </span><span class="k" data-group-id="3081532453-14">do</span><span class="w">
    </span><span class="n">autorecover_document_ids</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p" data-group-id="3081532453-15">(</span><span class="n">documents</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="3081532453-16">fn</span><span class="w"> </span><span class="n">document_id</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="k">case</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">find</span><span class="p" data-group-id="3081532453-17">(</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p" data-group-id="3081532453-18">(</span><span class="ni">&amp;1</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">document_id</span><span class="p" data-group-id="3081532453-18">)</span><span class="p" data-group-id="3081532453-17">)</span><span class="w"> </span><span class="k" data-group-id="3081532453-19">do</span><span class="w">
        </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="c1"># If document not in list, fetch it from database</span><span class="w">
          </span><span class="c1"># Only if created by current user (security check)</span><span class="w">
          </span><span class="n">document</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Blog</span><span class="o">.</span><span class="n">get_document!</span><span class="p" data-group-id="3081532453-20">(</span><span class="n">document_id</span><span class="p" data-group-id="3081532453-20">)</span><span class="w">

          </span><span class="k">if</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">creator_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="k" data-group-id="3081532453-21">do</span><span class="w">
            </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="3081532453-22">(</span><span class="s">&quot;Recovering document </span><span class="si" data-group-id="3081532453-23">#{</span><span class="n">document_id</span><span class="si" data-group-id="3081532453-23">}</span><span class="s"> for creator </span><span class="si" data-group-id="3081532453-24">#{</span><span class="n">document</span><span class="o">.</span><span class="n">creator_id</span><span class="si" data-group-id="3081532453-24">}</span><span class="s">&quot;</span><span class="p" data-group-id="3081532453-22">)</span><span class="w">
            </span><span class="n">acc</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="3081532453-25">[</span><span class="n">document</span><span class="p" data-group-id="3081532453-25">]</span><span class="w">
          </span><span class="k" data-group-id="3081532453-21">else</span><span class="w">
            </span><span class="n">acc</span><span class="w">
          </span><span class="k" data-group-id="3081532453-21">end</span><span class="w">

        </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="c1"># Document already in list</span><span class="w">
          </span><span class="n">acc</span><span class="w">
      </span><span class="k" data-group-id="3081532453-19">end</span><span class="w">
    </span><span class="k" data-group-id="3081532453-16">end</span><span class="p" data-group-id="3081532453-15">)</span><span class="w">
  </span><span class="k" data-group-id="3081532453-14">end</span><span class="w">
</span><span class="k" data-group-id="3081532453-1">end</span></code></pre>
<p>
As a security measure, we verify that recovered documents were uploaded by the current user, preventing unauthorized access to documents uploaded by other users.</p>
<h2 id="cleanup">
Step 3: Adding Cleanup for Orphaned Documents</h2>
<p>
Now we need to implement a cleanup mechanism to handle orphaned documents - files that were uploaded but never associated with a blog post.</p>
<p>
These orphaned documents can occur in several scenarios:</p>
<ul>
  <li>
A user uploads files but abandons the form without saving  </li>
  <li>
A user uploads files, removes them from the UI, then saves the post  </li>
</ul>
<p>
Since these documents exist in both the database and storage but aren’t linked to any post, they consume resources unnecessarily and should be periodically cleaned up.</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Blog</span><span class="w"> </span><span class="k" data-group-id="7987883263-1">do</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">list_orphan_documents</span><span class="p" data-group-id="7987883263-2">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="7987883263-3">[</span><span class="p" data-group-id="7987883263-3">]</span><span class="p" data-group-id="7987883263-2">)</span><span class="w"> </span><span class="k" data-group-id="7987883263-4">do</span><span class="w">
    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="7987883263-5">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">:count</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="7987883263-5">)</span><span class="w">
    </span><span class="n">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="7987883263-6">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">:interval</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;day&quot;</span><span class="p" data-group-id="7987883263-6">)</span><span class="w">

    </span><span class="nc">Document</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">where</span><span class="p" data-group-id="7987883263-7">(</span><span class="p" data-group-id="7987883263-8">[</span><span class="n">d</span><span class="p" data-group-id="7987883263-8">]</span><span class="p">,</span><span class="w"> </span><span class="n">is_nil</span><span class="p" data-group-id="7987883263-9">(</span><span class="n">d</span><span class="o">.</span><span class="n">post_id</span><span class="p" data-group-id="7987883263-9">)</span><span class="p" data-group-id="7987883263-7">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">where</span><span class="p" data-group-id="7987883263-10">(</span><span class="p" data-group-id="7987883263-11">[</span><span class="n">d</span><span class="p" data-group-id="7987883263-11">]</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="o">.</span><span class="n">inserted_at</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ago</span><span class="p" data-group-id="7987883263-12">(</span><span class="o">^</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">interval</span><span class="p" data-group-id="7987883263-12">)</span><span class="p" data-group-id="7987883263-10">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">all</span><span class="p" data-group-id="7987883263-13">(</span><span class="p" data-group-id="7987883263-13">)</span><span class="w">
  </span><span class="k" data-group-id="7987883263-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">delete_orphan_documents</span><span class="p" data-group-id="7987883263-14">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="7987883263-15">[</span><span class="p" data-group-id="7987883263-15">]</span><span class="p" data-group-id="7987883263-14">)</span><span class="w"> </span><span class="k" data-group-id="7987883263-16">do</span><span class="w">
    </span><span class="n">orphan_documents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list_orphan_documents</span><span class="p" data-group-id="7987883263-17">(</span><span class="n">opts</span><span class="p" data-group-id="7987883263-17">)</span><span class="w">
    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="7987883263-18">(</span><span class="s">&quot;Deleting </span><span class="si" data-group-id="7987883263-19">#{</span><span class="n">length</span><span class="p" data-group-id="7987883263-20">(</span><span class="n">orphan_documents</span><span class="p" data-group-id="7987883263-20">)</span><span class="si" data-group-id="7987883263-19">}</span><span class="s"> orphan documents&quot;</span><span class="p" data-group-id="7987883263-18">)</span><span class="w">

    </span><span class="n">orphan_documents</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">each</span><span class="p" data-group-id="7987883263-21">(</span><span class="k" data-group-id="7987883263-22">fn</span><span class="w"> </span><span class="n">document</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="7987883263-23">(</span><span class="s">&quot;Deleting orphan document </span><span class="si" data-group-id="7987883263-24">#{</span><span class="n">document</span><span class="o">.</span><span class="n">id</span><span class="si" data-group-id="7987883263-24">}</span><span class="s">&quot;</span><span class="p" data-group-id="7987883263-23">)</span><span class="w">
      </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DocumentFile</span><span class="o">.</span><span class="n">delete</span><span class="p" data-group-id="7987883263-25">(</span><span class="p" data-group-id="7987883263-26">{</span><span class="n">document</span><span class="o">.</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">document</span><span class="p" data-group-id="7987883263-26">}</span><span class="p" data-group-id="7987883263-25">)</span><span class="w">
      </span><span class="nc">Repo</span><span class="o">.</span><span class="n">delete</span><span class="p" data-group-id="7987883263-27">(</span><span class="n">document</span><span class="p" data-group-id="7987883263-27">)</span><span class="w">
    </span><span class="k" data-group-id="7987883263-22">end</span><span class="p" data-group-id="7987883263-21">)</span><span class="w">

    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="7987883263-28">(</span><span class="s">&quot;Deleted </span><span class="si" data-group-id="7987883263-29">#{</span><span class="n">length</span><span class="p" data-group-id="7987883263-30">(</span><span class="n">orphan_documents</span><span class="p" data-group-id="7987883263-30">)</span><span class="si" data-group-id="7987883263-29">}</span><span class="s"> orphan documents&quot;</span><span class="p" data-group-id="7987883263-28">)</span><span class="w">
  </span><span class="k" data-group-id="7987883263-16">end</span><span class="w">
</span><span class="k" data-group-id="7987883263-1">end</span></code></pre>
<p>
Create an Oban worker to perform the cleanup:</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Workers.CleanupOrphanDocuments</span><span class="w"> </span><span class="k" data-group-id="7629251360-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Oban.Worker</span><span class="p">,</span><span class="w"> </span><span class="ss">queue</span><span class="p">:</span><span class="w"> </span><span class="ss">:maintenance</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Logger</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">MyApp.Blog</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="nc">Oban.Worker</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">perform</span><span class="p" data-group-id="7629251360-2">(</span><span class="c">_job</span><span class="p" data-group-id="7629251360-2">)</span><span class="w"> </span><span class="k" data-group-id="7629251360-3">do</span><span class="w">
    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="7629251360-4">(</span><span class="s">&quot;Starting cleanup of orphaned documents&quot;</span><span class="p" data-group-id="7629251360-4">)</span><span class="w">
    </span><span class="nc">Blog</span><span class="o">.</span><span class="n">delete_orphan_documents</span><span class="p" data-group-id="7629251360-5">(</span><span class="p" data-group-id="7629251360-5">)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w">
  </span><span class="k" data-group-id="7629251360-3">end</span><span class="w">
</span><span class="k" data-group-id="7629251360-1">end</span></code></pre>
<p>
Configure the job to run periodicaly:</p>
<pre><code class="makeup elixir"><span class="c1"># In your config</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:my_app</span><span class="p">,</span><span class="w"> </span><span class="nc">Oban</span><span class="p">,</span><span class="w">
  </span><span class="ss">plugins</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1847430886-1">[</span><span class="w">
    </span><span class="p" data-group-id="1847430886-2">{</span><span class="nc">Oban.Plugins.Cron</span><span class="p">,</span><span class="w">
     </span><span class="ss">crontab</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1847430886-3">[</span><span class="w">
       </span><span class="p" data-group-id="1847430886-4">{</span><span class="s">&quot;0 3 * * *&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Workers.CleanupOrphanDocuments</span><span class="p" data-group-id="1847430886-4">}</span><span class="w">
     </span><span class="p" data-group-id="1847430886-3">]</span><span class="p" data-group-id="1847430886-2">}</span><span class="w">
  </span><span class="p" data-group-id="1847430886-1">]</span></code></pre>
<h2>
Key Takeaways</h2>
<p>
This approach provides a robust solution for handling file uploads in Phoenix LiveView applications. The key principles are:</p>
<ol>
  <li>
<strong>Upload immediately, associate later</strong>: Create documents and store files as soon as they’re uploaded, then link them to posts only when the form is saved  </li>
  <li>
<strong>Implement auto-recovery</strong>: Use hidden form inputs to preserve document IDs across server restarts  </li>
  <li>
<strong>Add security checks</strong>: Always verify file ownership during recovery to prevent unauthorized access  </li>
  <li>
<strong>Schedule cleanup jobs</strong>: Regularly remove orphaned documents to prevent storage bloat  </li>
</ol>
<p>
This pattern ensures users never lose their uploaded files due to server restarts or connectivity issues, providing a seamless and reliable file upload experience in LiveView applications.</p>

          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card sticky-top shadow-sm shadow-hover mb-3" style="top: 20px;">
        <div class="card-body">
          <h5 class="card-title mb-3">Table of content</h5>
          <hr>
          <ul class="list-unstyled">
  
    <li class="mb-2">
  <a href="liveview-file-uploads-autorecover.html#file-upload">
Step 1: Basic File Upload and Association</a>
  
</li>
  
    <li class="mb-2">
  <a href="liveview-file-uploads-autorecover.html#auto-recover">
Step 2: Adding Auto-Recovery Mechanism</a>
  
</li>
  
    <li class="mb-2">
  <a href="liveview-file-uploads-autorecover.html#cleanup">
Step 3: Adding Cleanup for Orphaned Documents</a>
  
</li>
  
</ul>
        </div>
      </div>
    </div>

  </div>
</main>
</main>

<footer class="footer"></footer>
  </body>
</html>